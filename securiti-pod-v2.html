<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Deployment Guide: Securiti ePod V2 on AWS EKS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Visualization & Content Choices:
        - Deployment Phases (Overall): Goal: Informative, structured guide -> Viz: Formal HTML sections with clear headings, detailed text, and embedded code blocks. Justification: Provides a comprehensive, step-by-step instructional document. Method: HTML, Tailwind.
        - Key Tools (eksctl, awscli, kubectl, Helm): Goal: Inform -> Viz: Plain text mentions or formal bullet points. Justification: Professional presentation. Method: HTML, Tailwind.
        - Core Actions (e.g., Cluster Create, Addon Install, Helm Deploy): Goal: Inform -> Viz: Detailed descriptions and direct code blocks. Justification: Provides complete instructions. Method: HTML, Tailwind.
        - Detailed Commands: Goal: Inform/Reference -> Viz: Inline code blocks within each section, with copy buttons. Interaction: Direct copy to clipboard. Justification: Provides immediate access to all commands without navigation, fulfilling the single-page requirement for an official guide. Method: HTML, JS.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .guide-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .guide-section h2 {
            color: #0284C7;
            border-bottom: 2px solid #7DD3FC;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .guide-section h3 {
            color: #0369A1;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .key-point {
            background-color: #F0F9FF;
            padding: 1rem;
            border-left: 4px solid #0EA5E9;
            margin-bottom: 1rem;
            border-radius: 0.25rem 0.5rem 0.5rem 0.25rem;
        }
        .key-point p {
            margin-bottom: 0.5rem;
        }
        .key-point code {
            background-color: #E0F2FE;
            color: #0369A1;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-size: 0.85em;
        }
        .config-highlight {
            font-size: 0.875rem;
            color: #075985;
        }
        .config-highlight strong {
            color: #0369A1;
        }
        .code-block {
            background-color: #1e293b; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .copy-button-inline {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #38bdf8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-button-inline:hover {
            background-color: #0ea5e9;
        }
        .placeholder {
            color: #fbbf24;
            font-weight: bold;
        }
        /* Sidebar specific styles */
        .sidebar {
            width: 100%;
            max-width: 250px; /* Fixed width for sidebar */
            background-color: #F8FAFC; /* slate-50 */
            border-right: 1px solid #E2E8F0; /* slate-200 */
            padding: 1rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: calc(100vh - 64px); /* Adjust based on header height */
        }
        .sidebar-nav a {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            color: #475569; /* slate-600 */
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav a:hover {
            background-color: #E0F2FE; /* sky-100 */
            color: #0EA5E9; /* sky-500 */
        }
        .sidebar-nav a.active {
            background-color: #BFDBFE; /* blue-200 */
            color: #1D4ED8; /* blue-700 */
            font-weight: 600;
        }
        .sidebar-nav .sub-item {
            padding-left: 1.5rem;
            font-size: 0.85rem;
            color: #64748B; /* slate-500 */
        }
        .sidebar-nav .sub-item.active {
            background-color: #E0F2FE; /* sky-100 */
            color: #0EA5E9; /* sky-500 */
            font-weight: 500;
        }

        /* Mobile specific styles for sidebar toggle */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 64px; /* Below header */
                height: calc(100% - 64px);
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 50;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            .overlay.open {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-sky-50 text-slate-700 antialiased">

    <header class="bg-sky-700 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center">
            <button id="menu-toggle" class="md:hidden p-2 rounded-md hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white mr-2">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            <h1 class="text-xl md:text-2xl font-bold">Official Deployment Guide: Securiti ePod V2 on AWS EKS</h1>
        </div>
    </header>

    <div class="overlay" id="sidebar-overlay"></div>

    <div class="flex flex-col md:flex-row flex-grow">
        <aside id="sidebar" class="sidebar">
            <nav id="sidebar-nav" class="sidebar-nav">
                </nav>
        </aside>

        <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl md:ml-0">
            <section class="text-center mb-8 p-4 bg-white rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-sky-600 mb-2" id="introduction-section">Introduction</h2>
                <p class="text-slate-600">This document provides a detailed, step-by-step guide for deploying Securiti ePod V2 on an Amazon Elastic Kubernetes Service (EKS) cluster using AWS CloudShell. It covers all necessary configurations, tool installations, and troubleshooting considerations to ensure a successful deployment.</p>
                <p class="text-slate-600 mt-2">All commands required for the deployment process are embedded directly within each section for easy access and execution.</p>
            </section>

            <section class="guide-section">
                <h2 class="text-2xl font-semibold" id="phase-1-prerequisites-initial-setup">Phase 1: Prerequisites & Initial Setup</h2>
                <p class="mb-4 text-slate-600">This phase focuses on preparing your AWS CloudShell environment by installing the necessary command-line tools and configuring your AWS credentials, which are essential for interacting with AWS services and your EKS cluster.</p>
                
                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-1-1-setup-eksctl">1.1. Setup `eksctl` (EKS Cluster Management CLI)</h3>
                <p class="mb-2 text-slate-600"><code>eksctl</code> is a powerful command-line tool designed for creating and managing Amazon EKS clusters. Execute the following commands to install it:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-setup-eksctl">Copy</button>
                    <pre><code id="code-setup-eksctl">curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp\nsudo mv /tmp/eksctl /usr/local/bin</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-1-2-setup-awscli">1.2. Setup `awscli` (AWS Command Line Interface)</h3>
                <p class="mb-2 text-slate-600">The AWS CLI is a unified tool to manage your AWS services from the command line. While AWS CloudShell typically comes with <code>awscli</code> pre-installed, you can use these commands to ensure it's up-to-date or to reinstall it if necessary:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-setup-awscli">Copy</button>
                    <pre><code id="code-setup-awscli">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"\\nunzip awscliv2.zip\\nsudo ./aws/install</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-1-3-install-kubectl">1.3. Install `kubectl` (Kubernetes CLI)</h3>
                <p class="mb-2 text-slate-600"><code>kubectl</code> is the standard command-line tool for running commands against Kubernetes clusters. Install it using the following:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-install-kubectl">Copy</button>
                    <pre><code id="code-install-kubectl">curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"\\nchmod +x kubectl\\nsudo mv kubectl /usr/local/bin/</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-1-4-configure-aws-credentials">1.4. Configure AWS Credentials</h3>
                <p class="mb-2 text-slate-600">Before proceeding, you must configure your AWS credentials. Upon executing the command below, you will be prompted to enter your AWS Access Key ID, AWS Secret Access Key, your preferred Default region (e.g., <code>us-west-2</code>), and the Default output format (e.g., <code>json</code>).</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-configure-aws-credentials">Copy</button>
                    <pre><code id="code-configure-aws-credentials">aws configure</code></pre>
                </div>
            </section>

            <section class="guide-section">
                <h2 class="text-2xl font-semibold" id="phase-2-eks-cluster-creation-configuration">Phase 2: EKS Cluster Creation & Configuration</h2>
                <p class="mb-4 text-slate-600">This phase guides you through the creation of your EKS cluster and the configuration of essential add-ons and IAM roles required for the Securiti ePod V2 deployment.</p>
                
                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-1-create-eks-cluster">2.1. Create the EKS Cluster</h3>
                <p class="mb-2 text-slate-600">Execute this command to create your EKS cluster. For this guide, the cluster name is <code>securiti-epod-cluster</code> and the node group name is <code>securiti-nodegroup</code>. Remember to replace <span class="placeholder">&lt;YOUR_EMAIL_HERE&gt;</span> with your actual email for the Owner tag.</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-create-eks-cluster">Copy</button>
                    <pre><code id="code-create-eks-cluster">eksctl create cluster \\
  --name securiti-epod-cluster \\
  --region us-west-2 \\
  --nodegroup-name securiti-nodegroup \\
  --node-type m5.2xlarge \\
  --nodes 1 \\
  --nodes-min 1 \\
  --nodes-max 1 \\
  --managed \\
  --tags "Owner=<span class="placeholder">&lt;YOUR_EMAIL_HERE&gt;</span>"</code></pre>
                </div>
                <p class="text-sm text-slate-500 mt-2">Note: During cluster creation, you might encounter warnings regarding Amazon Linux 2 (AL2) AMIs deprecation. These are informational and do not impede the cluster creation process. Additionally, <code>eksctl</code> may indicate that OIDC is disabled by default for the <code>vpc-cni</code> addon; this will be addressed in subsequent steps.</p>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-2-install-ebs-csi-driver">2.2. Install EBS CSI Driver Addon</h3>
                <p class="mb-2 text-slate-600">The AWS EBS CSI Driver addon enables your EKS cluster to manage EBS volumes for persistent storage. Ensure you use the correct cluster name (<code>securiti-epod-cluster</code>) when running this command:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-install-ebs-csi-driver">Copy</button>
                    <pre><code id="code-install-ebs-csi-driver">eksctl create addon \\
  --name aws-ebs-csi-driver \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --force</code></pre>
                </div>
                <p class="text-sm text-slate-500 mt-2">Note: You might receive a warning indicating that recommended policies for the <code>aws-ebs-csi-driver</code> cannot be automatically configured due to OIDC being disabled. This will be resolved by enabling OIDC and attaching the policy via Pod Identity Associations in later steps.</p>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-3-attach-iam-policy-node-role">2.3. Attach IAM Policy to Node Role</h3>
                <p class="mb-2 text-slate-600">This step grants the necessary IAM permissions for the EBS CSI driver to interact with AWS EBS on behalf of your worker nodes. Execute the following commands:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-attach-iam-policy-node-role">Copy</button>
                    <pre><code id="code-attach-iam-policy-node-role">NODE_ROLE_NAME=$(aws eks describe-nodegroup \\
  --cluster-name securiti-epod-cluster \\
  --nodegroup-name securiti-nodegroup \\
  --region us-west-2 \\
  --query 'nodegroup.nodeRole' \\
  --output text | awk -F'/' '{print $2}')\\naws iam attach-role-policy \\
  --role-name "$NODE_ROLE_NAME" \\
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-4-enable-oidc-provider-vpc-cni">2.4. Enable OIDC Provider for `vpc-cni` Addon</h3>
                <p class="mb-2 text-slate-600">To properly configure IAM permissions for the <code>vpc-cni</code> addon, it is necessary to enable the OpenID Connect (OIDC) provider for your EKS cluster:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-enable-oidc-vpc-cni">Copy</button>
                    <pre><code id="code-enable-oidc-vpc-cni">eksctl utils associate-iam-oidc-provider \\
  --region us-west-2 \\
  --cluster securiti-epod-cluster \\
  --approve</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-5-create-iam-policy-vpc-cni">2.5. Create IAM Policy for `vpc-cni`</h3>
                <p class="mb-2 text-slate-600">Download the AWS-managed policy definition for <code>vpc-cni</code> and then create the corresponding IAM policy in your AWS account:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-create-iam-policy-vpc-cni">Copy</button>
                    <pre><code id="code-create-iam-policy-vpc-cni">curl -o vpc-cni-policy.json https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/v1.12/iam_policy.json\\naws iam create-policy \\
  --policy-name AmazonEKS_CNI_Policy \\
  --policy-document file://vpc-cni-policy.json</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-6-create-iam-role-pod-identity">2.6. Create IAM Role with Pod Identity Association</h3>
                <p class="mb-2 text-slate-600">Create an IAM role and associate it with EKS Pod Identity for the <code>vpc-cni</code> addon. This is the recommended method for granting IAM access. Remember to replace <span class="placeholder">&lt;YOUR_ACCOUNT_ID&gt;</span> with your actual AWS account ID:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-create-iam-role-pod-identity">Copy</button>
                    <pre><code id="code-create-iam-role-pod-identity">eksctl create iamidentitymapping \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --arn arn:aws:iam::<span class="placeholder">&lt;YOUR_ACCOUNT_ID&gt;</span>:role/AmazonEKS_CNI_Policy \\
  --username system:node:{{EC2PrivateDNSName}} \\
  --group system:bootstrappers,system:nodes</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-7-update-vpc-cni-addon">2.7. Update `vpc-cni` Addon with IAM Role</h3>
                <p class="mb-2 text-slate-600">Update the <code>vpc-cni</code> addon to ensure it utilizes the newly configured IAM role and Pod Identity association:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-update-vpc-cni-addon">Copy</button>
                    <pre><code id="code-update-vpc-cni-addon">eksctl update addon \\
  --name vpc-cni \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --force</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-8-update-kubeconfig">2.8. Update `kubeconfig`</h3>
                <p class="mb-2 text-slate-600">This command configures your local <code>kubectl</code> context to connect to your newly created EKS cluster, allowing you to manage it:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-update-kubeconfig">Copy</button>
                    <pre><code id="code-update-kubeconfig">aws eks --region us-west-2 update-kubeconfig --name securiti-epod-cluster</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-2-9-verify-cluster-access">2.9. Verify Cluster Access</h3>
                <p class="mb-2 text-slate-600">Confirm that your <code>kubectl</code> is correctly configured and that your EKS nodes are registered and ready within the cluster:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-verify-cluster-access">Copy</button>
                    <pre><code id="code-verify-cluster-access">kubectl get nodes</code></pre>
                </div>
            </section>

            <section class="guide-section">
                <h2 class="text-2xl font-semibold" id="phase-3-storage-class-setup">Phase 3: Storage Class Setup</h2>
                <p class="mb-4 text-slate-600">This phase involves defining and applying a default storage class for your EKS cluster, which dictates how persistent storage volumes are provisioned for your applications.</p>
                
                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-3-1-create-storage-class-yaml">3.1. Create `storage-class.yaml`</h3>
                <p class="mb-2 text-slate-600">This YAML file defines a storage class named <code>ebs-sc</code> that utilizes the EBS CSI provisioner. Create a file named <code class="bg-slate-200 px-1 rounded">storage-class.yaml</code> with the following content:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-create-storage-class-yaml">Copy</button>
                    <pre><code id="code-create-storage-class-yaml">apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-3-2-apply-storage-class">3.2. Apply Storage Class</h3>
                <p class="mb-2 text-slate-600">Apply the newly created storage class definition to your Kubernetes cluster:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-apply-storage-class">Copy</button>
                    <pre><code id="code-apply-storage-class">kubectl apply -f storage-class.yaml</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-3-3-bind-storage-class">3.3. Bind Storage Class (Optional)</h3>
                <p class="mb-2 text-slate-600">The <code>volumeBindingMode</code> for a StorageClass is immutable after creation. If it's already set to <code>WaitForFirstConsumer</code> (as in the provided YAML), attempting to patch it to <code>Immediate</code> will result in an error. <code>WaitForFirstConsumer</code> is generally the recommended and safer mode for dynamic provisioning.</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-bind-storage-class">Copy</button>
                    <pre><code id="code-bind-storage-class"># kubectl patch storageclass ebs-sc -p '{"volumeBindingMode":"Immediate"}'</code></pre>
                </div>
            </section>

            <section class="guide-section">
                <h2 class="text-2xl font-semibold" id="phase-4-helm-securiti-epod-v2-deployment">Phase 4: Helm & Securiti ePod V2 Deployment</h2>
                <p class="mb-4 text-slate-600">This crucial phase involves installing Helm, preparing the Securiti ePod V2 Helm chart, and deploying the application onto your EKS cluster.</p>
                
                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-1-download-helm-chart">4.1. Download Helm Chart</h3>
                <p class="mb-2 text-slate-600">Download the Securiti appliance Helm chart package, which contains the necessary deployment definitions:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-download-helm-chart">Copy</button>
                    <pre><code id="code-download-helm-chart">wget "https://privaci-registry.s3.us-west-2.amazonaws.com/artifacts/prod/securiti-appliance-chart-1.132.0-15rc.tar.gz" -O securiti-appliance-chart.tar.gz</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-2-save-values-yaml">4.2. Save `values.yaml`</h3>
                <p class="mb-2 text-slate-600">Create the <code>values.yaml</code> file, which provides configuration overrides for the Securiti appliance Helm chart. It is critical to customize the Redis password and review other global settings as per your requirements. Ensure you change <code class="bg-slate-200 px-1 rounded">CHANGEMEOROVERRIDEME</code> for the Redis password.</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-save-values-yaml">Copy</button>
                    <pre><code id="code-save-values-yaml">global:
  registry: "app.securiti.ai"
  privilegedContainers: false
  custom_registry: "false"
  appliance_install_type: byok
  enableCertificateHandling: true
  installation_location: "/mnt"
  system_appliance: "false"
  appliance_application_directory: "/securiti-app-securiti-ai"
  namespace: "securiti-ai"
  cloud_type: ""
  appliance_byok: "true"
  redis:
    password: "<span class="placeholder">CHANGEMEOROVERRIDEME</span>"
  externalRedis: false
  externalEs: false
tags:
  redis: true
  elasticsearch: true
  prometheus: true
  prometheus-node-exporter: false
  metrics-server: true
  kube-metrics-adapter: true
  deployer-service: true
ranger-policy-service:
  httpsService:
    nodePort: 31000
  httpService:
    nodePort: 31001
redis:
  metrics:
    extraArgs:
      check-keys: "db1=securiti-appliance-securiti-ai-downloader-tasks-queue"
kube-metrics-adapter:
  enableCustomMetricsApi: "true"
  enableExternalMetricsApi: "true"
prometheus:
  serverFiles:
    prometheus.yml:
      scrape_configs:
        - job_name: 'redis-metrics-server'
          static_configs:
            - targets:
                - "{{ .Release.Name }}-redis-metrics.securiti-ai.svc.cluster.local:9121"
  server:
    resources:
      limits: null
    persistentVolume:
      size: 8Gi</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-3-install-helm">4.3. Install Helm</h3>
                <p class="mb-2 text-slate-600">Install the Helm CLI, which is required to deploy Kubernetes applications using Helm charts:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-install-helm">Copy</button>
                    <pre><code id="code-install-helm">curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-4-create-namespace">4.4. Create Namespace</h3>
                <p class="mb-2 text-slate-600">The Helm installation requires that the target namespace, <code>securiti-ai</code>, already exists in your cluster. Create it using the following command:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-create-namespace">Copy</button>
                    <pre><code id="code-create-namespace">kubectl create namespace securiti-ai</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-5-patch-existing-clusterrole">4.5. Patch Existing ClusterRole</h3>
                <p class="mb-2 text-slate-600">During Helm deployment, you might encounter errors if certain Kubernetes resources, such as <code>ClusterRole system:metrics-server-aggregated-reader</code>, already exist but lack Helm-specific ownership metadata. To resolve this, patch the existing <code>ClusterRole</code> with the necessary Helm-compatible labels and annotations:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-patch-clusterrole">Copy</button>
                    <pre><code id="code-patch-clusterrole">kubectl label clusterrole system:metrics-server-aggregated-reader \\
  app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate clusterrole system:metrics-server-aggregated-reader \\
  meta.helm.sh/release-name=priv-appliance \\
  meta.helm.sh/release-namespace=securiti-ai --overwrite</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-6-patch-existing-apiservice">4.6. Patch Existing APIService</h3>
                <p class="mb-2 text-slate-600">Similarly, if the <code>APIService v1beta1.metrics.k8s.io</code> exists and is not managed by Helm, you must patch it with the appropriate Helm ownership metadata to prevent deployment conflicts:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-patch-apiservice">Copy</button>
                    <pre><code id="code-patch-apiservice">kubectl label apiservice v1beta1.metrics.k8s.io \\
  app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate apiservice v1beta1.metrics.k8s.io \\
  meta.helm.sh/release-name=priv-appliance \\
  meta.helm.sh/release-namespace=securiti-ai --overwrite</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-4-7-deploy-securiti-helm-chart">4.7. Deploy Securiti ePod V2 Helm Chart</h3>
                <p class="mb-2 text-slate-600">Finally, install or upgrade the Securiti appliance using Helm. Replace <span class="placeholder">&lt;YOUR_BASE64_ENCODED_LICENSE_KEY&gt;</span> with your actual base64-encoded license key:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-deploy-securiti-helm-chart">Copy</button>
                    <pre><code id="code-deploy-securiti-helm-chart">helm upgrade -n securiti-ai --install priv-appliance securiti-appliance-chart.tar.gz -f values.yaml \\
  --timeout=900s \\
  --create-namespace \\
  --set global.license="<span class="placeholder">&lt;YOUR_BASE64_ENCODED_LICENSE_KEY&gt;</span>"</code></pre>
                </div>
                <p class="text-sm text-slate-500 mt-2">Note: The <code>--create-namespace</code> flag is included for robustness, though the namespace was manually created in step 4.4. The chart file used is <code>securiti-appliance-chart.tar.gz</code> as downloaded.</p>
            </section>

            <section class="guide-section">
                <h2 class="text-2xl font-semibold" id="phase-5-verification-registration">Phase 5: Verification & Registration</h2>
                <p class="mb-4 text-slate-600">This final phase involves verifying the successful deployment of the Securiti ePod V2 pods and registering the appliance with the Securiti platform.</p>
                
                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-5-1-verify-installation">5.1. Verify Installation</h3>
                <p class="mb-2 text-slate-600">Confirm that all Securiti ePod V2 pods are running correctly within the <code>securiti-ai</code> namespace:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-verify-installation">Copy</button>
                    <pre><code id="code-verify-installation">kubectl get pods -n securiti-ai</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-sky-600 mb-3" id="phase-5-2-register-securiti-appliance">5.2. Register Securiti Appliance</h3>
                <p class="mb-2 text-slate-600">Register your Securiti appliance with the Securiti platform using the <code>securitictl</code> command. Replace <span class="placeholder">&lt;YOUR_BASE64_ENCODED_LICENSE_KEY&gt;</span> with your actual base64-encoded license key:</p>
                <div class="code-block">
                    <button class="copy-button-inline" data-code-id="code-register-securiti-appliance">Copy</button>
                    <pre><code id="code-register-securiti-appliance">kubectl -n securiti-ai exec -it deploy/priv-appliance-config-controller -- securitictl register -l "<span class="placeholder">&lt;YOUR_BASE64_ENCODED_LICENSE_KEY&gt;</span>"</code></pre>
                </div>
            </section>
            
            <footer class="text-center mt-10 py-6 border-t border-sky-200">
                <p class="text-sm text-slate-500">&copy; Securiti ePod V2 Deployment Guide. All rights reserved.</p>
            </footer>

        </main>
    </div>

<script>
    const stepsData = [
        {
            phase: "1. Initial Setup",
            title: "1.1. Setup eksctl",
            id: "setup-eksctl",
            code: `curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp\\nsudo mv /tmp/eksctl /usr/local/bin`
        },
        {
            phase: "1. Initial Setup",
            title: "1.2. Setup awscli",
            id: "setup-awscli",
            code: `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"\\nunzip awscliv2.zip\\nsudo ./aws/install`
        },
        {
            phase: "1. Initial Setup",
            title: "1.3. Install kubectl",
            id: "install-kubectl",
            code: `curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"\\nchmod +x kubectl\\nsudo mv kubectl /usr/local/bin/`
        },
        {
            phase: "1. Initial Setup",
            title: "1.4. Configure AWS Credentials",
            id: "configure-aws-credentials",
            code: `aws configure`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.1. Create the EKS Cluster",
            id: "create-eks-cluster",
            code: `eksctl create cluster \\
  --name securiti-epod-cluster \\
  --region us-west-2 \\
  --nodegroup-name securiti-nodegroup \\
  --node-type m5.2xlarge \\
  --nodes 1 \\
  --nodes-min 1 \\
  --nodes-max 1 \\
  --managed \\
  --tags "Owner=<YOUR_EMAIL_HERE>"`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.2. Install EBS CSI Driver Addon",
            id: "install-ebs-csi-driver",
            code: `eksctl create addon \\
  --name aws-ebs-csi-driver \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --force`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.3. Attach IAM Policy to Node Role",
            id: "attach-iam-policy-node-role",
            code: `NODE_ROLE_NAME=$(aws eks describe-nodegroup \\
  --cluster-name securiti-epod-cluster \\
  --nodegroup-name securiti-nodegroup \\
  --region us-west-2 \\
  --query 'nodegroup.nodeRole' \\
  --output text | awk -F'/' '{print $2}')\\naws iam attach-role-policy \\
  --role-name "$NODE_ROLE_NAME" \\
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.4. Enable OIDC Provider for vpc-cni",
            id: "enable-oidc-vpc-cni",
            code: `eksctl utils associate-iam-oidc-provider \\
  --region us-west-2 \\
  --cluster securiti-epod-cluster \\
  --approve`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.5. Create IAM Policy for vpc-cni",
            id: "create-iam-policy-vpc-cni",
            code: `curl -o vpc-cni-policy.json https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/v1.12/iam_policy.json\\naws iam create-policy \\
  --policy-name AmazonEKS_CNI_Policy \\
  --policy-document file://vpc-cni-policy.json`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.6. Create IAM Role with Pod Identity",
            id: "create-iam-role-pod-identity",
            code: `eksctl create iamidentitymapping \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --arn arn:aws:iam::<YOUR_ACCOUNT_ID>:role/AmazonEKS_CNI_Policy \\
  --username system:node:{{EC2PrivateDNSName}} \\
  --group system:bootstrappers,system:nodes`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.7. Update vpc-cni Addon with IAM Role",
            id: "update-vpc-cni-addon",
            code: `eksctl update addon \\
  --name vpc-cni \\
  --cluster securiti-epod-cluster \\
  --region us-west-2 \\
  --force`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.8. Update kubeconfig",
            id: "update-kubeconfig",
            code: `aws eks --region us-west-2 update-kubeconfig --name securiti-epod-cluster`
        },
        {
            phase: "2. EKS Cluster & Configuration",
            title: "2.9. Verify Cluster Access",
            id: "verify-cluster-access",
            code: `kubectl get nodes`
        },
        {
            phase: "3. Storage Class Setup",
            title: "3.1. Create storage-class.yaml",
            id: "create-storage-class-yaml",
            code: `apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-sc
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete`
        },
        {
            phase: "3. Storage Class Setup",
            title: "3.2. Apply Storage Class",
            id: "apply-storage-class",
            code: `kubectl apply -f storage-class.yaml`
        },
        {
            phase: "3. Storage Class Setup",
            title: "3.3. Bind Storage Class (Optional)",
            id: "bind-storage-class",
            code: `# kubectl patch storageclass ebs-sc -p '{"volumeBindingMode":"Immediate"}'`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.1. Download Helm Chart",
            id: "download-helm-chart",
            code: `wget "https://privaci-registry.s3.us-west-2.amazonaws.com/artifacts/prod/securiti-appliance-chart-1.132.0-15rc.tar.gz" -O securiti-appliance-chart.tar.gz`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.2. Save values.yaml",
            id: "save-values-yaml",
            code: `global:
  registry: "app.securiti.ai"
  privilegedContainers: false
  custom_registry: "false"
  appliance_install_type: byok
  enableCertificateHandling: true
  installation_location: "/mnt"
  system_appliance: "false"
  appliance_application_directory: "/securiti-app-securiti-ai"
  namespace: "securiti-ai"
  cloud_type: ""
  appliance_byok: "true"
  redis:
    password: "<span class="placeholder">CHANGEMEOROVERRIDEME</span>"
  externalRedis: false
  externalEs: false
tags:
  redis: true
  elasticsearch: true
  prometheus: true
  prometheus-node-exporter: false
  metrics-server: true
  kube-metrics-adapter: true
  deployer-service: true
ranger-policy-service:
  httpsService:
    nodePort: 31000
  httpService:
    nodePort: 31001
redis:
  metrics:
    extraArgs:
      check-keys: "db1=securiti-appliance-securiti-ai-downloader-tasks-queue"
kube-metrics-adapter:
  enableCustomMetricsApi: "true"
  enableExternalMetricsApi: "true"
prometheus:
  serverFiles:
    prometheus.yml:
      scrape_configs:
        - job_name: 'redis-metrics-server'
          static_configs:
            - targets:
                - "{{ .Release.Name }}-redis-metrics.securiti-ai.svc.cluster.local:9121"
  server:
    resources:
      limits: null
    persistentVolume:
      size: 8Gi`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.3. Install Helm",
            id: "install-helm",
            code: `curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.4. Create Namespace",
            id: "create-namespace",
            code: `kubectl create namespace securiti-ai`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.5. Patch Existing ClusterRole",
            id: "patch-clusterrole",
            code: `kubectl label clusterrole system:metrics-server-aggregated-reader \\
  app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate clusterrole system:metrics-server-aggregated-reader \\
  meta.helm.sh/release-name=priv-appliance \\
  meta.helm.sh/release-namespace=securiti-ai --overwrite`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.6. Patch Existing APIService",
            id: "patch-apiservice",
            code: `kubectl label apiservice v1beta1.metrics.k8s.io \\
  app.kubernetes.io/managed-by=Helm --overwrite

kubectl annotate apiservice v1beta1.metrics.k8s.io \\
  meta.helm.sh/release-name=priv-appliance \\
  meta.helm.sh/release-namespace=securiti-ai --overwrite`
        },
        {
            phase: "4. Helm & Securiti ePod V2 Deployment",
            title: "4.7. Deploy Securiti ePod V2 Helm Chart",
            id: "deploy-securiti-helm-chart",
            code: `helm upgrade -n securiti-ai --install priv-appliance securiti-appliance-chart.tar.gz -f values.yaml \\
  --timeout=900s \\
  --create-namespace \\
  --set global.license="<YOUR_BASE64_ENCODED_LICENSE_KEY>"`
        },
        {
            phase: "5. Verification & Registration",
            title: "5.1. Verify Installation",
            id: "verify-installation",
            code: `kubectl get pods -n securiti-ai`
        },
        {
            phase: "5. Verification & Registration",
            title: "5.2. Register Securiti Appliance",
            id: "register-securiti-appliance",
            code: `kubectl -n securiti-ai exec -it deploy/priv-appliance-config-controller -- securitictl register -l "<YOUR_BASE64_ENCODED_LICENSE_KEY>"`
        }
    ];

    document.addEventListener('DOMContentLoaded', function () {
        const sidebarNav = document.getElementById('sidebar-nav');
        const sections = document.querySelectorAll('main section[id]');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        // Function to create slug from text
        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w-]+/g, '')       // Remove all non-word chars
                .replace(/--+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        // Build sidebar navigation
        function buildSidebarNav() {
            const phaseMap = {};

            // Collect all h2 (phases) and h3 (sub-steps)
            document.querySelectorAll('main h2, main h3').forEach(heading => {
                let id = heading.id;
                if (!id) { // Ensure all headings have an ID
                    id = slugify(heading.textContent);
                    heading.id = id;
                }

                if (heading.tagName === 'H2') {
                    phaseMap[id] = {
                        title: heading.textContent,
                        element: heading,
                        subsections: []
                    };
                } else if (heading.tagName === 'H3') {
                    // Find the parent H2
                    let parentSection = heading.closest('section');
                    let parentH2 = parentSection ? parentSection.querySelector('h2') : null;
                    if (parentH2 && phaseMap[parentH2.id]) {
                        phaseMap[parentH2.id].subsections.push({
                            title: heading.textContent,
                            element: heading,
                            id: id
                        });
                    }
                }
            });

            // Render navigation
            for (const phaseId in phaseMap) {
                const phase = phaseMap[phaseId];
                const phaseLink = document.createElement('a');
                phaseLink.href = `#${phaseId}`;
                phaseLink.textContent = phase.title;
                phaseLink.classList.add('block', 'px-3', 'py-2', 'rounded-md', 'text-slate-700', 'font-semibold', 'hover:bg-sky-100', 'hover:text-sky-700');
                sidebarNav.appendChild(phaseLink);

                if (phase.subsections.length > 0) {
                    const ul = document.createElement('ul');
                    ul.classList.add('ml-4', 'mb-2');
                    phase.subsections.forEach(sub => {
                        const subLink = document.createElement('a');
                        subLink.href = `#${sub.id}`;
                        subLink.textContent = sub.title;
                        subLink.classList.add('block', 'px-3', 'py-1', 'rounded-md', 'text-slate-600', 'text-sm', 'hover:bg-sky-50', 'hover:text-sky-600', 'sub-item');
                        ul.appendChild(subLink);
                    });
                    sidebarNav.appendChild(ul);
                }
            }
        }

        // Highlight active link on scroll
        function highlightActiveLink() {
            let currentActive = null;
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                // Check if the section is in the viewport, considering some offset from the top
                if (rect.top <= 100 && rect.bottom >= 100) { // 100px offset from top
                    currentActive = section.id;
                }
            });

            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').substring(1) === currentActive) {
                    link.classList.add('active');
                }
            });
        }

        // Initialize sidebar navigation
        buildSidebarNav();
        highlightActiveLink(); // Set initial active link

        // Event listeners
        window.addEventListener('scroll', highlightActiveLink);

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('open');
        });

        // Close sidebar when a link is clicked on mobile
        sidebarNav.addEventListener('click', (event) => {
            if (event.target.tagName === 'A' && window.innerWidth < 768) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            }
        });

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-md shadow-lg transition-opacity duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function copyToClipboard(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (err) {
                showToast('Failed to copy!');
            }
            document.body.removeChild(textarea);
        }

        const stepsDataMap = {}; // To quickly find code from stepsData by id
        
        stepsData.forEach(step => {
            if (step.code) {
                stepsDataMap[`code-${step.id}`] = step.code;
            }
        });

        document.querySelectorAll('.copy-button-inline').forEach(button => {
            button.addEventListener('click', () => {
                const codeId = button.dataset.codeId;
                const originalCode = stepsDataMap[codeId];

                if (originalCode) {
                    const plainTextCode = originalCode.replace(/<[^>]*>/g, '');
                    copyToClipboard(plainTextCode, button);
                }
            });
        });
    });
</script>
</body>
</html>
